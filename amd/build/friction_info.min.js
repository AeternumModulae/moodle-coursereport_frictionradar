/* This file is part of Moodle - https://moodle.org/
 *
 * Moodle is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * Moodle is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Moodle.  If not, see <http://www.gnu.org/licenses/>.
 */
define(['core/modal_factory'],function(c){const a=a=>(a??'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'),b=b=>a(b).replace(/\n/g,'<br>'),d=a=>{try{const b=JSON.parse(a||'[]');return Array.isArray(b)?b:[]}catch(a){return[]}},e=()=>{const a=Array.from(document.querySelectorAll('.friction-info'));if(!a.length)return;a.forEach(a=>{a.style.width='auto'});let b=0;a.forEach(a=>{const c=a.getBoundingClientRect().width;c>b&&(b=c)});if(b>0){const c=`${Math.ceil(b)}px`;a.forEach(a=>{a.style.width=c})}},f=()=>{window.requestAnimationFrame(()=>{window.requestAnimationFrame(e)})},g=(h,f,g,j,d,e,c)=>{if(!d&&!e.length&&!c)return'';const i=e.map(b=>`
            <tr>
                <td><code>${a(b.key??'')}</code></td>
                <td class="text-end"><strong>${a(b.value??'')}</strong></td>
            </tr>
        `).join('');return`
            <div class="mt-3">
                <button type="button"
                        class="btn btn-link p-2 friction-toggle"
                        style="text-decoration:none;">
                    <span class="friction-arrow me-1">▶</span>
                    <span class="fw-semibold">${a(h)}</span>
                </button>

                <div class="friction-details mt-2" style="display:none;">
                    ${d?`<pre class="p-2 bg-light border rounded small" style="white-space: pre-wrap;"><code>${a(d)}</code></pre>`:''}

                    ${e.length?`
                        <div class="table-responsive">
                            <table class="table table-sm mb-2">
                                <thead>
                                    <tr>
                                        <th>${a(f)}</th>
                                        <th class="text-end">${a(g)}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${i}
                                </tbody>
                            </table>
                        </div>
                    `:''}

                    ${c?`
                        <div class="small text-muted">
                            ${b(c)}
                        </div>
                    `:''}
                </div>
            </div>
        `};return{init:function(){f(),window.addEventListener('resize',f),document.querySelectorAll('.friction-info').forEach(f=>{f.addEventListener('click',function(){const h=a(f.textContent),i=`
                        <p>
                            <strong>${a(f.dataset.uiScore)}:</strong>
                            ${a(f.dataset.score)}
                        </p>

                        <p>${b(f.dataset.explanation)}</p>

                        ${g(f.dataset.uiFormula,f.dataset.uiParam,f.dataset.uiValue,f.dataset.uiNotes,f.dataset.formula||'',d(f.dataset.inputs||'[]'),f.dataset.notes||'')}

                        <p class="mt-3"><strong>${b(f.dataset.what)}</strong></p>
                        <p>${b(f.dataset.action)}</p>
                    `;c.create({type:c.types.DEFAULT,title:h,body:i,large:!0}).then(function(a){a.show();const b=a.getRoot()[0];b.querySelectorAll('.friction-toggle').forEach(a=>{a.addEventListener('click',function(){const b=a.nextElementSibling,d=a.querySelector('.friction-arrow'),c=b.style.display!=='none';b.style.display=c?'none':'block',d.textContent=c?'▶':'▼'})})})})})}}})
