define(['core/modal_factory'],function(c){const a=a=>(a??'').toString().replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;'),b=b=>a(b).replace(/\n/g,'<br>'),d=a=>{try{const b=JSON.parse(a||'[]');return Array.isArray(b)?b:[]}catch(a){return[]}},e=(h,f,g,j,d,e,c)=>{if(!d&&!e.length&&!c)return'';const i=e.map(b=>`
            <tr>
                <td><code>${a(b.key??'')}</code></td>
                <td class="text-end"><strong>${a(b.value??'')}</strong></td>
            </tr>
        `).join('');return`
            <div class="mt-3">
                <button type="button"
                        class="btn btn-link p-2 friction-toggle"
                        style="text-decoration:none;">
                    <span class="friction-arrow me-1">▶</span>
                    <span class="fw-semibold">${a(h)}</span>
                </button>

                <div class="friction-details mt-2" style="display:none;">
                    ${d?`<pre class="p-2 bg-light border rounded small" style="white-space: pre-wrap;"><code>${a(d)}</code></pre>`:''}

                    ${e.length?`
                        <div class="table-responsive">
                            <table class="table table-sm mb-2">
                                <thead>
                                    <tr>
                                        <th>${a(f)}</th>
                                        <th class="text-end">${a(g)}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${i}
                                </tbody>
                            </table>
                        </div>
                    `:''}

                    ${c?`
                        <div class="small text-muted">
                            ${b(c)}
                        </div>
                    `:''}
                </div>
            </div>
        `};return{init:function(){document.querySelectorAll('.friction-info').forEach(f=>{f.addEventListener('click',function(){const g=a(f.textContent),h=`
                        <p>
                            <strong>${a(f.dataset.uiScore)}:</strong>
                            ${a(f.dataset.score)}
                        </p>

                        <p>${b(f.dataset.explanation)}</p>

                        ${e(f.dataset.uiFormula,f.dataset.uiParam,f.dataset.uiValue,f.dataset.uiNotes,f.dataset.formula||'',d(f.dataset.inputs||'[]'),f.dataset.notes||'')}

                        <p class="mt-3"><strong>${b(f.dataset.what)}</strong></p>
                        <p>${b(f.dataset.action)}</p>
                    `;c.create({type:c.types.DEFAULT,title:g,body:h,large:!0}).then(function(a){a.show();const b=a.getRoot()[0];b.querySelectorAll('.friction-toggle').forEach(a=>{a.addEventListener('click',function(){const b=a.nextElementSibling,d=a.querySelector('.friction-arrow'),c=b.style.display!=='none';b.style.display=c?'none':'block',d.textContent=c?'▶':'▼'})})})})})}}})