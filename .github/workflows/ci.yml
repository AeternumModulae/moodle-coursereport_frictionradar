name: CI

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  php-quality:
    name: PHPCS and PHPMD
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        php: ['8.2', '8.3']
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer
          ini-values: max_input_vars=5000
          ini-values: max_input_vars=5000

      - name: Install QA tools
        env:
          COMPOSER_AUTH: '{}'
          GITHUB_TOKEN: ''
        run: |
          git config --global --unset-all http.https://github.com/.extraheader || true
          git config --global url."https://github.com/".insteadOf "git@github.com:"
          git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"
          git config --global credential.helper ""
          composer config --global github-protocols https
          composer config --global preferred-install dist
          composer init --no-interaction --name coursereport/frictionradar --description "CI QA deps"
          composer config repositories.moodle-coding-standard '{"type":"package","package":{"name":"moodlehq/moodle-coding-standard","version":"dev-master","dist":{"url":"https://github.com/open-lms-open-source/moodle-coding-standard/archive/refs/heads/master.zip","type":"zip"}}}'
          composer config minimum-stability dev
          composer config prefer-stable true
          composer require --no-interaction --prefer-dist --no-progress --dev moodlehq/moodle-coding-standard:dev-master squizlabs/php_codesniffer:^3.10 phpmd/phpmd:^2.15
          vendor/bin/phpcs --config-set installed_paths vendor/moodlehq/moodle-coding-standard
          php -r "\$file='vendor/moodlehq/moodle-coding-standard/moodle/Sniffs/Commenting/InlineCommentSniff.php'; \$code=file_get_contents(\$file); \$code=str_replace(\"['content']{0}\", \"['content'][0]\", \$code); \$code=str_replace(\"['content']{1}\", \"['content'][1]\", \$code); \$code=str_replace(\"['content']{2}\", \"['content'][2]\", \$code); file_put_contents(\$file, \$code);"
          php -r "\$file='vendor/moodlehq/moodle-coding-standard/moodle/Sniffs/Files/MoodleInternalSniff.php'; \$code=file_get_contents(\$file); \$code=str_replace(\"\\\$file->addWarning('Expected MOODLE_INTERNAL check or config.php inclusion', \\\$pointer);\", \"\\\$file->addWarning('Expected MOODLE_INTERNAL check or config.php inclusion', \\\$pointer, 'MissingMoodleInternal');\", \$code); file_put_contents(\$file, \$code);"
          php -r "\$file='vendor/moodlehq/moodle-coding-standard/moodle/Sniffs/NamingConventions/ValidVariableNameSniff.php'; \$code=file_get_contents(\$file); \$code=str_replace(\"\\\$phpcsfile->addError(\\\$error, \\\$stackptr);\", \"\\\$phpcsfile->addError(\\\$error, \\\$stackptr, 'InvalidVariableName');\", \$code); file_put_contents(\$file, \$code);"
          php -r "\$file='vendor/moodlehq/moodle-coding-standard/moodle/Sniffs/NamingConventions/ValidFunctionNameSniff.php'; \$code=file_get_contents(\$file); \$code=str_replace(\"\\\$phpcsfile->adderror(\\\$error, \\\$stackptr);\", \"\\\$phpcsfile->addError(\\\$error, \\\$stackptr, 'InvalidFunctionName');\", \$code); file_put_contents(\$file, \$code);"

      - name: Run PHPCS
        env:
          PHPCS_BOOTSTRAP: .github/phpcs-bootstrap.php
        run: php -d auto_prepend_file=.github/phpcs-bootstrap.php vendor/bin/phpcs -q --standard=.github/phpcs.xml --bootstrap=.github/phpcs-bootstrap.php --extensions=php --warning-severity=0 --ignore=vendor/*,.github/* .

      - name: Run PHPMD
        run: vendor/bin/phpmd . text .github/phpmd.xml --exclude vendor

  phpunit:
    name: PHPUnit (MySQL/PostgreSQL)
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - php: '8.2'
            moodle-branch: 'MOODLE_405_STABLE'
            database: 'mysqli'
            db-service: 'mysql'
            db-user: 'root'
            db-pass: 'root'
            db-name: 'moodle'
          - php: '8.3'
            moodle-branch: 'MOODLE_405_STABLE'
            database: 'pgsql'
            db-service: 'postgres'
            db-user: 'postgres'
            db-pass: 'postgres'
            db-name: 'moodle'
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: root
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h 127.0.0.1 -u root -proot"
          --health-interval=10s --health-timeout=5s --health-retries=5
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s --health-timeout=5s --health-retries=5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          tools: composer

      - name: Install moodle-plugin-ci
        run: |
          composer create-project --no-interaction --prefer-dist moodlehq/moodle-plugin-ci ci
          echo "$GITHUB_WORKSPACE/ci/bin" >> $GITHUB_PATH

      - name: Install Moodle
        run: >
          moodle-plugin-ci install
          --plugin ./
          --db-type ${{ matrix.database }}
          --db-host 127.0.0.1
          --db-user ${{ matrix.db-user }}
          --db-pass ${{ matrix.db-pass }}
          --db-name ${{ matrix.db-name }}
          --branch ${{ matrix.moodle-branch }}

      - name: Run PHPUnit
        run: moodle-plugin-ci phpunit

  js-lint:
    name: ESLint (amd/src)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install JS deps
        run: npm install --no-audit --no-fund

      - name: Run ESLint
        run: npm run lint:js
